<Window x:Class="Phoenix.UI.WPF.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Phoenix.UI.WPF"
        xmlns:vm="clr-namespace:Phoenix.UI.WPF.ViewModels"
        xmlns:views="clr-namespace:Phoenix.UI.WPF.Views"
        mc:Ignorable="d"
        Title="Phoenix ePub Reader" 
        Height="700" Width="1100"
        MinHeight="500" MinWidth="800"
        Background="{DynamicResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen"
        AllowDrop="True"
        Drop="Window_Drop"
        DragOver="Window_DragOver">
    
    <Window.Resources>
        <DataTemplate DataType="{x:Type vm:LibraryViewModel}">
            <views:LibraryView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:ReaderViewModel}">
            <views:ReaderView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:SettingsViewModel}">
            <views:SettingsView/>
        </DataTemplate>
    </Window.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header - Compact -->
        <Border Grid.Row="0" Background="{DynamicResource PrimaryBrush}" Padding="12,6">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- Logo and Title -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="🔥" FontSize="18" VerticalAlignment="Center" Margin="0,0,6,0"/>
                    <TextBlock Text="Phoenix" 
                               FontSize="16" FontWeight="SemiBold" 
                               Foreground="White" VerticalAlignment="Center"/>
                </StackPanel>
                
                <!-- Navigation Buttons -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Content="📚" 
                            ToolTip="Library"
                            Command="{Binding ShowLibraryCommand}"
                            Style="{DynamicResource IconButtonStyle}"
                            Foreground="White" FontSize="16" Padding="8,4"/>
                    
                    <!-- Settings Button with Popup -->
                    <ToggleButton x:Name="SettingsToggle"
                                  Content="⚙️" 
                                  ToolTip="Settings"
                                  Background="Transparent"
                                  BorderThickness="0"
                                  Foreground="White" FontSize="16" Padding="8,4"
                                  Cursor="Hand"/>
                    
                    <Popup IsOpen="{Binding IsChecked, ElementName=SettingsToggle, Mode=TwoWay}"
                           PlacementTarget="{Binding ElementName=SettingsToggle}"
                           Placement="Bottom"
                           StaysOpen="False"
                           AllowsTransparency="True">
                        <Border Background="{DynamicResource SurfaceBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="16"
                                Margin="0,4,0,0">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.2"/>
                            </Border.Effect>
                            <StackPanel Width="280">
                                <TextBlock Text="Settings" 
                                           FontSize="16" FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           Margin="0,0,0,12"/>
                                
                                <!-- Theme -->
                                <TextBlock Text="Theme" FontWeight="Medium" Margin="0,0,0,6"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <ComboBox SelectedIndex="{Binding Settings.Theme, Converter={StaticResource EnumToIntConverter}, Mode=TwoWay}"
                                          SelectionChanged="SettingsComboBox_SelectionChanged"
                                          Margin="0,0,0,12">
                                    <ComboBoxItem Content="Default (ePub Style)"/>
                                    <ComboBoxItem Content="Light"/>
                                    <ComboBoxItem Content="Dark"/>
                                    <ComboBoxItem Content="Sepia"/>
                                </ComboBox>
                                
                                <!-- Font Size -->
                                <TextBlock Text="Font Size" FontWeight="Medium" Margin="0,0,0,6"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <ComboBox ItemsSource="{Binding SettingsViewModel.AvailableFontSizes}"
                                          SelectedItem="{Binding Settings.FontSize, Mode=TwoWay}"
                                          SelectionChanged="SettingsComboBox_SelectionChanged"
                                          Margin="0,0,0,12"/>
                                
                                <!-- Font Family -->
                                <TextBlock Text="Font" FontWeight="Medium" Margin="0,0,0,6"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <ComboBox ItemsSource="{Binding SettingsViewModel.AvailableFonts}"
                                          SelectedItem="{Binding Settings.FontFamily, Mode=TwoWay}"
                                          SelectionChanged="SettingsComboBox_SelectionChanged"
                                          Margin="0,0,0,12"/>
                                
                                <!-- Line Height -->
                                <TextBlock Text="Line Height" FontWeight="Medium" Margin="0,0,0,6"
                                           Foreground="{DynamicResource TextPrimaryBrush}"/>
                                <ComboBox ItemsSource="{Binding SettingsViewModel.AvailableLineHeights}"
                                          SelectedItem="{Binding Settings.LineHeight, Mode=TwoWay}"
                                          SelectionChanged="SettingsComboBox_SelectionChanged"/>
                            </StackPanel>
                        </Border>
                    </Popup>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Main Content Area -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Sidebar (Table of Contents) - Only visible when reading a book -->
            <Border Grid.Column="0" 
                    Background="{DynamicResource SidebarBrush}"
                    BorderBrush="{DynamicResource BorderBrush}"
                    BorderThickness="0,0,1,0"
                    Width="{Binding Settings.SidebarWidth, FallbackValue=280}"
                    Visibility="{Binding IsSidebarVisible, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Sidebar Header -->
                    <Border Grid.Row="0" Padding="12,8" 
                            BorderBrush="{DynamicResource BorderBrush}" 
                            BorderThickness="0,0,0,1">
                        <Grid>
                            <TextBlock Text="Contents" 
                                       FontWeight="SemiBold" FontSize="13"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       VerticalAlignment="Center"/>
                            <Button Content="✕" 
                                    HorizontalAlignment="Right"
                                    Command="{Binding ToggleSidebarCommand}"
                                    Style="{DynamicResource IconButtonStyle}"
                                    Foreground="{DynamicResource TextPrimaryBrush}"
                                    FontSize="12" Padding="4,2"/>
                        </Grid>
                    </Border>
                    
                    <!-- TOC List -->
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding ReaderViewModel.Chapters}"
                             SelectedItem="{Binding ReaderViewModel.CurrentChapter}"
                             BorderThickness="0"
                             Background="Transparent"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem" BasedOn="{StaticResource SidebarItemStyle}"/>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Title}" 
                                           TextTrimming="CharacterEllipsis"
                                           FontSize="13"
                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                           Margin="{Binding Level, Converter={StaticResource LevelToMarginConverter}}"/>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>
            
            <!-- Content View -->
            <ContentControl Grid.Column="1" Content="{Binding CurrentView}"/>
        </Grid>
        
        <!-- Status Bar - More compact -->
        <Border Grid.Row="2" Background="{DynamicResource SurfaceBrush}" 
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0"
                Padding="12,4">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBlock Grid.Column="0" 
                           Text="{Binding StatusMessage}" 
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           FontSize="11"/>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="{Binding ReaderViewModel.ReadingProgress, StringFormat='{}{0:F0}%'}"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               FontSize="11"
                               Visibility="{Binding ReaderViewModel.CurrentBook, Converter={StaticResource NullToVisibilityConverter}}"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Loading Overlay -->
        <Border Grid.RowSpan="3" 
                Background="#80FFFFFF"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="Loading..." Margin="0,12,0,0" 
                           HorizontalAlignment="Center"
                           Foreground="{DynamicResource TextSecondaryBrush}"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
